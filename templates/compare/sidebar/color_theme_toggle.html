<div class="flex w-full items-center p-2" x-data="{
    theme: localStorage.getItem('theme'),
    isSystemDark: localStorage.getItem('isSystemDark') === 'true',
    documents: [document.documentElement],
    init() {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const iframes = document.querySelectorAll('iframe');
        iframes.forEach((iframe) => {
            iframe.addEventListener('load', () => {
                this.documents.push(iframe.contentDocument.documentElement);
            })
        });
        this.isSystemDark = mediaQuery.matches;
        this.theme ? this.setTheme(this.theme) : this.setTheme('auto');
    },
    setTheme(newTheme) {
        this.theme = newTheme;
        localStorage.setItem('theme', newTheme);
        this.updateTheme();
    },
    updateTheme() {
        const isDark = this.theme === 'dark' || (this.theme === 'auto' && this.isSystemDark);
        for (const doc of this.documents) {
          doc.classList.toggle('dark', isDark);
          doc.dataset.theme = this.theme;
        }
    },
    currentIcon() {
        if (this.theme === 'light') return 'light';
        if (this.theme === 'dark') return 'dark';
        return 'auto';
    },
  }">
  <button data-testid="theme-toggle-button" class="group relative inline-flex items-center justify-start rounded-lg w-full h-10 cursor-pointer duration-200 ease-in-out transition-color bg-green-900 text-white hover:bg-green-800"
  @click="
    if (currentIcon() === 'light') {
        setTheme('dark');
    } else if (currentIcon() === 'dark') {
        setTheme('auto');
    } else if (currentIcon() === 'auto') {
        setTheme('light');
    }
  "
  >
    <div class="flex flex-row items-center px-2" :class="$store.sidebar.isOpen ? 'gap-0' : 'gap-4'">
      <div class="w-6 h-6 flex items-center justify-center">
        <template x-if="currentIcon() === 'light'">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-[24px] h-[24px] group-hover:rotate-30 duration-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
          </svg>
        </template>
        <template x-if="currentIcon() === 'dark'">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-[24px] h-[24px] group-hover:rotate-30 duration-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
          </svg>
        </template>
        <template x-if="currentIcon() === 'auto'">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-[24px] h-[24px] fill-white group-hover:rotate-20 duration-300" viewBox="0 0 640 640">
            <!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
            <path d="M512 160L512 416L128 416L128 160L512 160zM128 96C92.7 96 64 124.7 64 160L64 416C64 451.3 92.7 480 128 480L272 480L256 528L184 528C170.7 528 160 538.7 160 552C160 565.3 170.7 576 184 576L456 576C469.3 576 480 565.3 480 552C480 538.7 469.3 528 456 528L384 528L368 480L512 480C547.3 480 576 451.3 576 416L576 160C576 124.7 547.3 96 512 96L128 96z"/>
          </svg>
        </template>
      </div>
      <div
      class="py-2 px-4 left-16 text-help-text-fg whitespace-nowrap rounded-lg font-base group-hover:block"
      aria-hidden="true"
      :class="$store.sidebar.isOpen ? 'bg-transparent text-sm' : 'bg-help-text-bg hidden text-xs'"
      >Toggle Theme</div>
    </div>
  </button>
</div>
